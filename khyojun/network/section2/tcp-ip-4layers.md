## TCP/IP 4계층 모델


### 계층 구조

보통 계층 모델이라고 하면 대표적으로 TCP/IP, OSI 7 계층에 대해 얘기를 많이 하는데 이 계층들은 네트워크에서 사용되는 통신 프로토콜의 집합으로 계층들은 프로토콜의 네트워킹 범위에 따라 네 개의 추상화 계층으로 구성이 된다.

- TCP/IP 4계층은 : 애플리케이션 -> 전송 -> 인터넷 -> 링크 계층으로 
- OSI 7계층은 : 애플리케이션,프레젠테이션,세션 -> 전송 -> 네트워크 -> 데이터링크,물리 이루어진다.

### 계층 특징

**이 각각의 계층들은 서로 영향을 받지 않도록 설계가 되었다.**

오늘은 그 중 TCP/IP 4계층에 대해서 알아보도록 하자.

### 계층을 대표하는 스택
- 애플리케이션 계층 : FTP, HTTP, SSH, SMTP, DNS
- 전송 계층 : TCP, UDP, QUIC
- 인터넷 계층 : IP, ARP, ICMP
- 링크 계층 : 이더넷

이렇게 계층을 대표하는 스택들이다. 이제 각각의 계층에 대해서 조금 더 자세히 알아보자.

---
### 애플리케이션 계층

> 애플리케이션 계층은 응용 프로그램이 사용되는 프로토콜 계층이며 웹 서비스, 이메일 등 서비스를 실질적으로 사람들에게 제공하는 층입니다.

- FTP(File Transfer Protocol): 장치와 장치 간의 파일을 전송하는데 사용되는 표준 통신 프로토콜
- SSH(Secure Shell) : 보안되지 않은 네트워크에서 네트워크 서비스를 안전하게 운영하기 위한 암호화 네트워크 프로토콜
- HTTP(Hyper Text Transfer Protocol) : World Wide Web을 위한 데이터 통신의 기초이자 웹 사이트를 이용하는 데 쓰는 프로토콜
- SMTP(Simple Mail Transfer Protocol) : 전자 메일 전송을 위한 인터넷 표준 통신 프로토콜
- DNS(Domain Name Service) : 도메인 이름과 IP 주소를 매핑해주는 서버

위 프로토콜들은 진짜로 애플리케이션에서 통신을 하기 위해서 사용하는 큰 범위의 프로토콜들임을 알 수 있었다. 이 중에서도 DNS, HTTP는 많이 들어봤지만 FTP, SSH, SMTP라는 프로토콜이 있었다는 것을 잘 알 수 있었다.

---

### 전송 계층

> 전송 계층은 송신자와 수신자를 연결하는 통신 서비스를 제공하며 연결 지향 데이터 스트림 지원, 신뢰성, 흐름 제어를 제공할 수 있으며 애플리케이션 계층 <-> 인터넷 계층 사이의 데이터가 전달될 때 중계 역할을 합니다. 대표적으로 TCP, UDP가 있습니다.


### TCP

>TCP는 패킷 사이의 순서를 보장하고 연결지향 프로토콜을 사용해서 연결을 하고 신뢰성을 구축하여 수신 여부를 확인하는 '가상회선 패킷 교환 방식'을 사용한다.

이 말은 즉, 내가 어떤 데이터를 전송하면 전송한대로 잘 간다는 것을 잘 보장해준다는 말이다.

### 가상회선 패킷 교환 방식
> 가상회선 패킷 교환 방식은 각 패킷에서 가상회선 식별자가 포함되며 모든 패킷을 전송하면 가상회선이 해제되고 패킷들은 전송된 '순서대로' 도착하는 방식을 말합니다.

이 말은 곧 데이터를 보내면 순서대로 받을 수 있는 방식을 사용한다는 의미로 알면 될 것 같다.


### UDP
>UDP는 순서를 보장하지 않고 수신 여부를 확인하지 않으며 단순히 데이터만 주는 '데이터그램 패킷 교환 방식'을 사용합니다.

TCP와는 다르게 순서를 보장하지 않는 방식으로 데이터를 준다고 한다.

### 데이터그램 패킷 교환 방식

> 패킷이 독립적으로 이동하며 최적의 경로를 선택하여 가는데, 하나의 메시지에서 분할된 여러 패킷은 서로 다른 경로로 전송될 수 있으며 도착한 '순서가 다를 수' 있는 방식을 뜻합니다.

결국 UDP는 TCP와는 다르게 순서를 보장해주지 않는다고 보면 될 거 같다. 


### TCP의 연결 성립 과정

TCP는 아까 얘기할 때 3-way-handshake라는 작업을 진행을 하는데 3 단계를 거친다고 한다.
>
>1. SYN : 클라이언트가 서버에게 클라이언트의 ISN(임의의 시퀀스 번호)를 담아서 SYN을 보낸다.
>2. SYN + ACK : 서버는 클라이언트의 SYN을 수신하고 서버의 ISN을 보내며 승인번호로 클라이언트에게 ISN+1을 보낸다.
>3. ACK : 클라이언트는 서버의 ISN+1한 값인 승인번호를 담아 ACK를 서버에 보낸다.

여기서 SYN은 연결 요청 플래그라고 하며, ACK는 응답 플래그라고 한다. 그래서 ISN이라는 시퀀스 번호를 통해서 서로 확인하고 보내주기 때문에 신뢰성이 있는 계층이라고 불린다.
반면, UDP는 이런 과정이 없어서 신뢰성이 없다고 한다.

이후에 TCP에서 연결을 끊을 때도 4-way-handshake라는 작업을 거친다고 한다.
>1. 클라이언트가 연결을 닫으려고 할 때 FIN으로 설정된 세그먼트를 보낸다. 그리고 클라이언트는 FIN_WAIT_1 상태로 들어가고 서버의 응답을 기다린다. 
>2. 서버는 클라이언트로 ACK라는 승인 세그먼트를 보낸다. 그리고 CLOSE_WAIT 상태에 들어간다. 클라이언트가 세그먼트를 받으면 FIN_WAIT_2라는 상태로 들어간다.
>3. 서버는 ACK를 보내고 일정 시간 이후에 클라이언트에 FIN이라는 세그먼트를 보낸다.
>4. 클라이언틑 TIME_WAIT 상태가 되고 다시 서버로 ACK를 보내서 서버는 CLOSED 상태가 된다. 이후 클라이언트트 어느 정도의 시간을 대기한 후 연결이 닫히고 클라이언트와 서버의 모든 자원의 연결이 해제된다.

>책 읽으며 참고할 용어
> - FIN: 연결종료 플래그 : 세션 연결을 종료시킬 때 사용되며 더이상 전송할 데이터가 없음을 나타낸다.
> - Active close: 먼저 연결을 끊고자 하는 쪽을 말함.
> - Passive close: Active close의 상대를 말함.
그런데 신기한게 왜 클라이언트는 마지막에 FIN이라는 세그먼트를 받고 왜 바로 CLOSED안하고 기다리고 있을까? 

> 4 way handshake 관련 참고 : https://velog.io/@evelyn82ny/4-way-handshake

1. 지연 패킷이라는 것이 발생할 수 있다. -> 패킷이 뒤늦게 도달하고 이를 처리하지 못하면 데이터 무결성 문제가 일어난다.
2. 두 장치가 연결이 닫혔는지 확인하기 위해서이다. -> 서버의 LAST_ACK라는 상태에서 닫히게 된다면 다시 새로운 연결을 할 때 장치가 줄곧 LAST_ACK라는 상태로 되어있어서 접속 오류가 나타나게 된다고 한다. 

> 데이터 무결성 : 데이터의 정확성과 일관성을 유지하고 보증하는 것

---

### 인터넷 계층

> 장치로부터 받은 네트워크 패킷을 IP 주소로 지정된 목적지로 전송하기 위해 사용되는 계층 IP, ARP, ICMP 등이 있고 패킷을 수신해야 할 상대의 주소를 지정하여 데이터를 전달한다.
> 그렇지만 상대방이 제대로 받았는지에 대해서 보장하지 않는 **비연결형적인 특징**이 있다.

---

### 링크 계층
> 전선, 광섬유, 무선 등으로 실질적으로 데이터를 전달하며 장치 간에 신호를 주고받는 '규칙'을 정하는 계층, 네트워크 계층이라고도 한다.


TCP/IP계층에서는 링크 계층이라고 했는데 OSI 계층에서는 물리, 링크 계층으로 나눈다. 그래서 역할을 보면

- 물리 계층 : 무선 LAN과 유선 LAN을 통해 0과 1로 이루어진 데이터를 보내는 계층
- 링크 계층 : '이더넷 프레임'을 통해 에러 확인, 흐름 제어, 접근 제어를 담당하는 계층

### 유선 LAN

선이 있는 우리가 알고 있는 그 LAN선이다. 

### 유선 LAN은 전이중화 통신을 사용
> 전이중화(full duplex) 통신 : 양쪽 장치가 동시에 송수신 할 수 있는 방식, 이는 송신로와 수신로로 나눠서 데이터를 주고받으며 현대의 고속 이더넷은 이 방식을 기반으로 통신한다.

### 예전의 방식 CSMA/CD
예전에는 반이중화 통신 중 하나인 CSMA/CD라는 방식을 썻다고 하는데 이 방식은 데이터를 보낸 이후 충돌이 발생하면 일정 시간 이후에 재전송하는 방식을 말한다. 근데 이 방식에서는 수신로, 송신로가 따로 있는게 아닌 한 경로로
이루어진 곳에서 통신이 되기 때문에 데이터를 보낼 때 충돌에 대하여 대비를 했어야 했다고 한다.

### 유선 LAN의 케이블 종류

- 트위스트 페어 케이블 : 여덟개의 구리선을 두 개씩 꼬아서 묶은 케이블이다.
    - UTP 케이블: 실드 처리되지 않은 것(우리가 알고 있는 랜선은 대부분 이 종류다)
    - STP 케이블: 실드 처리된 것(은박지 같이 덮어놓은 것을 실드 처리라고 한다.)
- 광섬유 케이블 : 광섬유로 만든 케이블이다. 레이저를 이용해서 통신하기 때문에 엄청 빠르다. 


### 무선 LAN

무선 LAN은 유선 LAN과는 달리 송신, 수신시 같은 채널을 사용하기 때문에 반이중화 통신을 사용한다.

### 반이중화 통신
> 반이중화 통신(half duplex)은 양쪽 장치는 서로 통신할 수 있지만, 동시에는 통신할 수 없으며 한 번에 한 방향만 통신할 수 있는 방식이다.

아까 말했던 것처럼 이렇게 통신을 하면 충돌에 대한 대비를 해야 하는데 그에 관련하여 CSMA/CA와 같은 방식으로 대비를 한다. 대비하는 방법은 다음과 같다.

1. 데이터를 송신하기 전에 무선 매체를 살핀다.
2. 캐리어 감지: 회선이 비어 있는지를 판단한다.
3. IFS(Inter FrameSpace): 랜덤 값을 기반으로 정해진 시간만큼 기다리며, 만약 무선 매체가 사용 중이면 점차 그 간격을 늘려가며 기다린다.
4. 이후에 데이터를 송신한다. 

이렇게 대비를 하긴 하지만 전이중화 통신은 이런 대비가 전혀 없다! 왜냐하면 충돌할 가능성 자체가 없기 때문이다.

### 무선 LAN의 주파수 2.4, 5

우리가 와이파이만 봐도 iptime2.4, iptime5G이렇게 생긴게 있는데 그 주파수에 따른 특징이 있다고 한다.

- 2.4GHz : 장애물에 강하다, 전자레인지, 무선 등 전파 간섭이 일어나는 경우가 많다.
- 5GHz : 사용할 수 있는 채널 수도 많고 동시에 사용할 수 있다. 그래서 깨끗한 전파 환경을 구축한다.

그래서 되도록이면 5GHz 환경을 사용하는 것이 좋다고 한다. 


### 와이파이 
> 와이파이는 전자기기들이 무선 LAN 신호에 연결할 수 있는 기술이다. 이를 사용하기 위하여서는 무선 접속 장치 AP(Access Point)가 있어야 한다. 우리는 이를 공유기라고 부른다.

그래서 보면 항상 유선 LAN을 공유기(AP)에 꽂으면 인터넷을 와이파이를 통해 연결할 수 있었던 것이다.

### BSS
>BSS(Basic Service Set)는 기본 서비스 집합이다. 단순 공유기를 통해 네트워크에 접속하는게 아닌 동일 BSS안에 있는 AP들과 장치들이 서로 통신이 가능한 구조를 말한다.

이 말이 너무 딱딱한데 한 마디로 한 와이파이를 같이 사용하고 있는 다수가 있다면 그건 BSS이다.


### ESS
>ESS(Extended Service Set)는 하나 이상의 연결된 BSS의 그룹이다.

말 그대로 BSS의 그룹들을 묶어 ESS라고 한다.



### 이더넷 프레임 

>이더넷 : OSI 7계층 중 2계층인 데이터링크 계층에 해당하는 대표적인 프로토콜이다.

이더넷 프레임이라고 있는데 데이터 링크 계층은 이더넷 프레임을 통해 전달받은 데이터의 에러를 검출하고 캡슐화하여 다음의 구조를 가진다. 

- Preamble: 이더넷 프레임이 시작임을 알린다.
- SFD(Start Frame Delimiter): 다음 바이트부터 MAC 주소 필드가 시작됨을 알린다.
- DMAC, SMAC : 수신 송신 MAC 주소를 말한다.
- EtherType : 데이터 계층 위의 계층인 IP 프로토콜을 정의한다. ex) IPv4, IPv6
- Payload : 전달받은 데이터
- CRC : 에러 확인 비트

>MAC 주소 : 컴퓨터나 노트북 등 각 장치에 LAN 카드가 있는데, 이를 구별하기 위한 식별번호를 말한다. 6바이트로 구성이 된다.

---

### 그러면 계층끼리는 데이터가 어떻게 통신이 될까?

예를 들어서 HTTP를 통하여서 웹 서버에 있는 데이터를 통신하면 어떤식으로 계층끼리 이동이 될까?

답은 캡슐화와, 비캡슐화의 과정을 통해 진행이 되는데 순서는 다음과 같을 거다.

클라이언트 애플리케이션 계층 -> 전송, 인터넷, 링크 -> 서버 링크, 인터넷, 전송, 애플리케이션 계층 순으로 전달이 된다.

그러면 클라이언트에서 전송 될 때 요청(request)값들이 캡슐화 과정을 거쳐서 전달이 되어 서버에서는 비캡슐화 과정을 거치며 데이터가 전송이 된다. 

나머진 그림이 있는 p.94~95를 참고하면 좋을 거 같다. 

### PDU

이런 식으로 네트워크의 어떤 계층간의 이동을 할 때 데이터의 전달되는 한 덩어리의 단위를 PDU(Protocol Data Unit)이라고 한다.

계층 별로 다음과 같다.

- 애플리케이션 계층 : 메시지
- 전송 계층 : 세그먼트(TCP), 데이터그램(UDP)
- 인터넷 계층 : 패킷
- 링크 계층 : 프레임(데이터 링크 계층), 비트(물리 계층)

